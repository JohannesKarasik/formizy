{% extends "main/base.html" %}
{% load static %}


{% block title %}
   {{ form_info.seo_title|default:form_info.title }} ‚Äî FillThatForm
{% endblock %}


{% block meta %}
   <meta name="description" content="{{ form_info.seo_description }}">
   <link rel="canonical" href="https://fillthatform.com/{{ country_code }}/{{ form_info.slug }}/">
   <meta property="og:title" content="{{ form_info.seo_title|default:form_info.title }}">
   <meta property="og:description" content="{{ form_info.seo_description }}">
   <meta property="og:type" content="article">
   <meta property="og:url" content="https://fillthatform.com/{{ country_code }}/{{ form_info.slug }}/">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600&display=swap" rel="stylesheet">


   <style>
     :root{
         --bg:#f7f9fc;
         --text:#1b2430;
         --muted:#5a6b87;
         --heading:#0b1220;
         --card:#ffffff;
         --border:#e6eaf2;
         --primary:#2563eb;
         --primary-600:#1e54d4;
         --primary-700:#1747bd;
         --success:#16a34a;
         --shadow:0 8px 24px rgba(16, 24, 64, 0.08);
         --radius:12px;
     }
     html, body {
         background: var(--bg);
         color: var(--text);
         font-family: Inter, ui-sans-serif, system-ui;
         margin: 0;
         padding: 0;
     }
     

     main {
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
      }

     .content-main {
         max-width: 900px;
         margin: auto;
         padding: 30px;
         overflow: hidden;
         position: relative;
     }

     /* üñº Frame around toolbar + viewer */
     .viewer-frame {
         background: #ffffff;
         border-radius: var(--radius);
         box-shadow: var(--shadow);
         border: 1px solid var(--border);
         overflow: hidden; /* keep corners round */
         margin-top: 24px;
     }

     /* üîù Top toolbar */
     .viewer-toolbar {
         display:flex;
         align-items:center;
         justify-content:space-between;
         padding: 8px 12px;
         background: #e5edf7;
         border-bottom: 1px solid var(--border);
     }

     .viewer-toolbar-left {
         font-size: 14px;
         font-weight: 600;
         color: #334155;
     }

     .viewer-toolbar-right {
         display:flex;
         align-items:center;
         gap:8px;
     }

     .toolbar-btn {
         border: 1px solid #cbd5f5;
         background: #ffffff;
         border-radius: 6px;
         padding: 4px 8px;
         font-size: 13px;
         cursor:pointer;
         display:flex;
         align-items:center;
         justify-content:center;
         min-width:28px;
     }

     .toolbar-btn-primary {
         border-color: transparent;
         background: linear-gradient(180deg,var(--primary),var(--primary-600));
         color:#fff;
         font-weight:600;
         padding: 6px 12px;
         font-size: 13px;
     }

     #zoom-label {
         font-size: 13px;
         color:#475569;
         min-width:40px;
         text-align:center;
     }

     /* üìÑ Scrollable PDF window */
     #pdf-scroll {
         height: 600px;
         overflow-y: auto;
         overflow-x: auto; /* allow side scroll when zoomed in */
         background: #f8f9fa;
     }

     #pdf-container {
         position: relative;
         width: 100%;
         display: inline-block;
         transform-origin: top left;
     }

     #pdf-pages {
         position: relative;
     }

     #pdf-pages canvas {
         display: block;
         margin: 0 auto 20px auto;
     }

     #pdf-container input[type="text"] {
         position:absolute;
         border: 1px solid rgba(37, 99, 235, 0.18);
         background: rgba(37, 99, 235, 0.08);
         border-radius: 6px;
         color: #0b1220;
         padding: 4px 6px;
         font-size: 14px;
         z-index: 20;
         box-sizing: border-box;
     }

     .checkbox {
        position:absolute;
        background: rgba(37, 99, 235, 0.08);
        border: none;
        border-radius: 4px;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size: 15px;
        font-weight: bold;
        user-select: none;
        z-index:20;
     }

     .signature-input {
    font-family: inherit;
    font-style: italic;
    border-style: dashed;
    background: rgba(248, 250, 252, 0.9);
}

/* Signature input styling */
.signature-input {
    position:absolute;
    border: 1px dashed rgba(107, 33, 168, 0.7);
    background: rgba(248, 250, 252, 0.9);
    border-radius: 6px;
    color: #0b1220;
    padding: 4px 6px;
    font-size: 18px;
    font-family: 'Caveat', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    font-weight: 500;
    letter-spacing: 0.02em;
    z-index: 20;
    box-sizing: border-box;
    cursor: pointer;
}


.signature-input::placeholder {
    color: #9ca3af;
}

/* Signature modal */
.sig-modal {
    position: fixed;
    inset: 0;
    display: none;              /* default hidden, toggled via JS */
    align-items: center;
    justify-content: center;
    z-index: 999;
}

.sig-modal.show {
    display: flex;
}

.sig-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
}

.sig-modal-dialog {
    position: relative;
    background: #ffffff;
    border-radius: 12px;
    padding: 18px 20px;
    box-shadow: 0 20px 40px rgba(15,23,42,0.25);
    max-width: 360px;
    width: 100%;
    z-index: 1;
    font-family: Inter, ui-sans-serif, system-ui;
}

.sig-modal-title {
    margin: 0 0 8px;
    font-size: 16px;
    font-weight: 600;
    color: #0b1220;
}

.sig-modal-label {
    font-size: 13px;
    color: #4b5563;
    margin-bottom: 4px;
}

.sig-modal-input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 14px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin-bottom: 10px;
}

.sig-modal-preview-label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
}

.sig-modal-preview {
    border-radius: 8px;
    border: 1px dashed #e5e7eb;
    background: #f9fafb;
    padding: 8px 10px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    font-family: 'Caveat', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    font-size: 28px;
    font-weight: 500;
    color: #111827;
}


.sig-modal-actions {
    margin-top: 14px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

.sig-btn {
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 13px;
    border: 1px solid transparent;
    cursor: pointer;
}

.sig-btn.secondary {
    background: #f3f4f6;
    color: #374151;
    border-color: #e5e7eb;
}

.sig-btn.primary {
    background: linear-gradient(135deg,#2563eb,#1d4ed8);
    color: white;
}

#payment-modal.auth-modal-hidden {
    display: none;
}

#payment-success-modal.auth-modal-hidden {
    display: none;
}

.download-spinner {
  border: 3px solid #ffffff55;
  border-top: 3px solid white;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  animation: spin 0.6s linear infinite;
  display: inline-block;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}


   </style>
{% endblock %}


{% block content %}

   {% include "main/login_register_modal.html" %}

   <main class="content-main">
    <form id="csrf-form">{% csrf_token %}</form>

       <h1 style="text-align:center;margin-bottom:15px;">
           {{ form_info.seo_h1|default:form_info.title }}
       </h1>

       {% if form_info.seo_intro %}
           <p style="text-align:center;margin-bottom:25px;color:#555;max-width:720px;margin:0 auto;">
               {{ form_info.seo_intro }}
           </p>
       {% endif %}

       <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

       <!-- üñº Viewer frame: toolbar + scroll area -->
       <div class="viewer-frame">

           <!-- üîù Toolbar -->
           <div class="viewer-toolbar">
            <div class="viewer-toolbar-left">
                PDF-Vorschau
            </div>
            <div class="viewer-toolbar-right">
                <button type="button" class="toolbar-btn" onclick="zoomOut()">‚àí</button>
                <span id="zoom-label">100%</span>
                <button type="button" class="toolbar-btn" onclick="zoomIn()">+</button>
         
                {% if not user.is_authenticated %}
                <button type="button" class="toolbar-btn toolbar-btn-primary" onclick="saveFieldsAndOpenAuth()">
                  PDF herunterladen
                </button>
              {% else %}
                <button type="button" class="toolbar-btn toolbar-btn-primary" onclick="saveFieldsAndDownload()">
                  PDF herunterladen
                </button>
              {% endif %}
              
            </div>
         </div>
         

           <!-- üìÑ FIXED-HEIGHT SCROLL BOX -->
           <div id="pdf-scroll">
               <div id="pdf-container">

                   <!-- PDF pages + overlays -->
                   <div id="pdf-pages">

                    {% if form_info.fields_schema %}
                    {% for field in form_info.fields_schema %}
                        {% if field.type == "checkbox" %}
                            <div class="checkbox"
                                 data-name="{{ field.name }}"
                                 data-page="{{ field.page|default:1 }}"
                                 data-px="{{ field.pixel_x }}"
                                 data-py="{{ field.pixel_y }}"
                                 data-pw="{{ field.pixel_width }}"
                                 data-ph="{{ field.pixel_height }}">
                            </div>
                
                        {% elif field.type == "signature" %}
                            <input type="text"
                                   class="signature-input"
                                   placeholder="Sign here"
                                   data-name="{{ field.name }}"
                                   data-page="{{ field.page|default:1 }}"
                                   data-px="{{ field.pixel_x }}"
                                   data-py="{{ field.pixel_y }}"
                                   data-pw="{{ field.pixel_width }}"
                                   data-ph="{{ field.pixel_height }}">
                
                        {% else %}
                            <input type="text"
                                   data-name="{{ field.name }}"
                                   data-page="{{ field.page|default:1 }}"
                                   data-px="{{ field.pixel_x }}"
                                   data-py="{{ field.pixel_y }}"
                                   data-pw="{{ field.pixel_width }}"
                                   data-ph="{{ field.pixel_height }}">
                        {% endif %}
                    {% endfor %}
                {% endif %}
                

                   </div>

               </div>
           </div>
       </div>  {# end .viewer-frame #}
       


<!-- === PAYMENT MODAL === -->
<div id="payment-modal" class="auth-modal-hidden">
    <div class="auth-backdrop" onclick="closePaymentModal()"></div>

    <div class="auth-box">
        <button class="auth-close" onclick="closePaymentModal()">√ó</button>

        <h2 style="text-align:center;margin-bottom:10px;">
            PDF herunterladen ‚Äì ‚Ç¨4.99
        </h2>

        <p style="text-align:center;color:#555;margin-bottom:20px;">
            F√ºr den Download des ausgef√ºllten PDFs ist eine einmalige Zahlung erforderlich.
        </p>

        <button class="auth-btn-primary" onclick="proceedPayment()">
            Jetzt bezahlen ‚Äì ‚Ç¨4.99
        </button>

        <!-- üí≥ Secure Stripe Payment message -->
<!-- üí≥ Secure Stripe Payment message -->
        <div style="margin-top:18px;opacity:0.85;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;">
            <span>Sicher bezahlen mit</span>
            <img src="{% static 'stripelogo.png' %}"
                alt="Stripe"
                style="height:22px;opacity:0.9;">
        </div>

    </div>
</div>

    <!-- === PAYMENT SUCCESS MODAL === -->
<div id="payment-success-modal" class="auth-modal-hidden">
    <div class="auth-backdrop" onclick="closeSuccessModal()"></div>

    <div class="auth-box">
        <button class="auth-close" onclick="closeSuccessModal()">√ó</button>

        <h2 style="text-align:center;margin-bottom:12px;">
            Zahlung erfolgreich üéâ
        </h2>

        <p style="text-align:center;color:#555;margin-bottom:20px;">
            Vielen Dank! Ihre Zahlung war erfolgreich.  
            Sie k√∂nnen das ausgef√ºllte PDF jetzt herunterladen.
        </p>

        <button id="success-download-btn" class="auth-btn-primary" onclick="downloadWithSpinner()">
            PDF herunterladen
        </button>
        
    </div>
</div>




<script>
    function getCSRF() {
        const token = document.querySelector("input[name='csrfmiddlewaretoken']");
        if (!token) {
            console.error("‚ùå CSRF token not found in DOM");
            return "";
        }
        return token.value;
    }
</script>

<script>

function saveFields() {
    const country = "{{ country_code }}";
    const slug = "{{ form_info.slug }}";
    const fields = collectFields();

    const storageKey = `pending_fields_${country}_${slug}`;
    sessionStorage.setItem(storageKey, JSON.stringify(fields));
    sessionStorage.setItem("pending_fields", JSON.stringify(fields));
}

function saveFieldsAndOpenAuth() {
    saveFields();
    openAuthModal();
}

function saveFieldsAndDownload() {
    saveFields();      // ensure saved before login check
    handleDownloadClick();
}



    const pdfUrl = "{{ pdf_url }}";
    const FIXED_WIDTH = 833;
    const VIEWER_SCALE = {{ viewer_scale|floatformat:6 }};

    const pagesContainer = document.getElementById("pdf-pages");

    pdfjsLib.getDocument(pdfUrl).promise.then(async pdf => {
        const pageCanvases = [];

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1 });

            const scale = FIXED_WIDTH / viewport.width;
            const scaledViewport = page.getViewport({ scale });

            const canvas = document.createElement("canvas");
            canvas.width = FIXED_WIDTH;
            canvas.height = scaledViewport.height;
            canvas.style.width = FIXED_WIDTH + "px";
            canvas.style.height = scaledViewport.height + "px";
            canvas.style.marginBottom = "20px";
            canvas.dataset.page = pageNum;

            pagesContainer.appendChild(canvas);

            await page.render({
                canvasContext: canvas.getContext("2d"),
                viewport: scaledViewport
            }).promise;

            pageCanvases.push(canvas);
        }

        positionOverlays(pageCanvases);

        // üîÅ After overlays exist, restore any saved field values
        restoreFieldsFromStorage();
    });

    function positionOverlays(pageCanvases) {
        const pageOffsets = {};
        pageCanvases.forEach(canvas => {
            const pageNum = canvas.dataset.page;
            pageOffsets[pageNum] = canvas.offsetTop;
        });

        const scale = VIEWER_SCALE;

        document.querySelectorAll('#pdf-pages input[type="text"], #pdf-pages .checkbox')
          .forEach(el => {
              const page = el.dataset.page || "1";
              const px = parseFloat(el.dataset.px || "0");
              const py = parseFloat(el.dataset.py || "0");
              const pw = parseFloat(el.dataset.pw || "0");
              const ph = parseFloat(el.dataset.ph || "0");

              const pageTop = pageOffsets[page] || 0;

              el.style.left   = (px * scale) + "px";
              el.style.top    = (pageTop + py * scale) + "px";
              el.style.width  = (pw * scale) + "px";
              el.style.height = (ph * scale) + "px";
          });
    }
</script>


<script>
    async function downloadFilledPDF() {
        const textFields = {};
        document.querySelectorAll('#pdf-pages input[type="text"]').forEach((input) => {
            const name = input.dataset.name;
            textFields[name] = input.value || "";
        });

        const checkboxFields = {};
        document.querySelectorAll('#pdf-pages .checkbox').forEach((box) => {
            const name = box.dataset.name;
            checkboxFields[name] = box.classList.contains("checked") ? "1" : "0";
        });

        const allFields = { ...textFields, ...checkboxFields };

        console.log("VIEWER SENDING FIELDS_DATA:", allFields);

        const res = await fetch(
            "{% url 'fill_pdf' country_code=country_code form_slug=form_info.slug %}",
            {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ fields_data: allFields })
            }
        );

        if (!res.ok) {
            const errorText = await res.text();
            console.error("Backend error:", errorText);
            alert("PDF error:\n" + errorText);
            return;
        }

        const blob = await res.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "{{ form_info.slug }}_filled.pdf";
        link.click();
    }

    // üîç Zoom logic (scales the whole viewer container)
    let currentZoom = 1.0;
    function applyZoom(){
        const container = document.getElementById("pdf-container");
        if (!container) return;
        container.style.transform = `scale(${currentZoom})`;
        const label = document.getElementById("zoom-label");
        if (label) label.textContent = Math.round(currentZoom * 100) + "%";
    }
    function zoomIn(){
        currentZoom = Math.min(currentZoom + 0.1, 2.0);
        applyZoom();
    }
    function zoomOut(){
        currentZoom = Math.max(currentZoom - 0.1, 0.5);
        applyZoom();
    }
    document.addEventListener("DOMContentLoaded", applyZoom);
</script>

{% if form_info.seo_sections %}
<div style="max-width:800px;margin:40px auto;padding:20px;background:white;border-radius:12px;border:1px solid #e6eaf2;line-height:1.6;">

    {% for section in form_info.seo_sections %}
        <h2 style="margin-top:30px;font-size:24px;color:#0b1220;">
            {{ section.heading }}
        </h2>

        <p style="margin-top:10px;color:#444;font-size:16px;">
            {{ section.body }}
        </p>
    {% endfor %}

</div>
{% endif %}

<!-- ‚úçÔ∏è Signature modal -->
<div id="signature-modal" class="sig-modal" aria-hidden="true">
    <div class="sig-modal-backdrop"></div>
    <div class="sig-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="sig-modal-title">
      <h2 id="sig-modal-title" class="sig-modal-title">Add your signature</h2>
  
      <label class="sig-modal-label" for="sig-name-input">Type your full name</label>
      <input id="sig-name-input" class="sig-modal-input" type="text" placeholder="e.g. Jane Doe">
  
      <div class="sig-modal-preview-label">Preview</div>
      <div id="sig-preview" class="sig-modal-preview"></div>
  
      <div class="sig-modal-actions">
        <button type="button" class="sig-btn secondary" id="sig-cancel-btn">Cancel</button>
        <button type="button" class="sig-btn primary" id="sig-apply-btn">Apply signature</button>
      </div>
    </div>
</div>

<script>
    function collectFields() {
        const fields = {};
    
        document.querySelectorAll('#pdf-pages input[type="text"]').forEach(input => {
            fields[input.dataset.name] = input.value || "";
        });
    
        document.querySelectorAll('#pdf-pages .checkbox').forEach(box => {
            fields[box.dataset.name] = box.classList.contains("checked") ? "1" : "0";
        });
    
        return fields;
    }
</script>

<script>
    (function(){
      let currentSignatureInput = null;
  
      const modal      = document.getElementById('signature-modal');
      const nameInput  = document.getElementById('sig-name-input');
      const preview    = document.getElementById('sig-preview');
      const cancelBtn  = document.getElementById('sig-cancel-btn');
      const applyBtn   = document.getElementById('sig-apply-btn');
  
      if(!modal || !nameInput || !preview) return;
  
      function openSignatureModal(targetInput){
        currentSignatureInput = targetInput;
        const existing = targetInput.value || '';
  
        nameInput.value = existing;
        preview.textContent = existing;
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        nameInput.focus();
      }
  
      function closeSignatureModal(){
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        currentSignatureInput = null;
      }
  
      // Update preview as user types
      nameInput.addEventListener('input', () => {
        preview.textContent = nameInput.value;
      });
  
      // Apply signature
      applyBtn.addEventListener('click', () => {
        if (!currentSignatureInput) return;
        currentSignatureInput.value = nameInput.value;
        closeSignatureModal();
      });
  
      // Cancel
      cancelBtn.addEventListener('click', () => {
        closeSignatureModal();
      });
  
      // Close when clicking backdrop
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.classList.contains('sig-modal-backdrop')) {
          closeSignatureModal();
        }
      });
  
      // ESC closes modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('show')) {
          closeSignatureModal();
        }
      });
  
      // Attach click handler to all signature inputs
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.signature-input').forEach(input => {
          input.readOnly = true; // user interacts via modal only
          input.addEventListener('click', () => openSignatureModal(input));
        });
      });
    })();
</script>

<script>
    function openSuccessModal() {
        document.getElementById("payment-success-modal").classList.remove("auth-modal-hidden");
    }
    
    function closeSuccessModal() {
        document.getElementById("payment-success-modal").classList.add("auth-modal-hidden");
    }
</script>

<script>
    async function startStripeCheckout(country, slug) {
        const res = await fetch(`/${country}/${slug}/create-checkout-session/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            }
        });
    
        const data = await res.json();
    
        const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}"); // Inject from Django
    
        await stripe.redirectToCheckout({ sessionId: data.id });
    }
</script>

<script>
async function handleDownloadClick() {
    const country = "{{ country_code }}";
    const slug = "{{ form_info.slug }}";

    // ALWAYS collect fields
    const fields = collectFields();

    // üîë Use per-form key so we can restore after redirect
    const storageKey = `pending_fields_${country}_${slug}`;
    sessionStorage.setItem(storageKey, JSON.stringify(fields));
    // fallback legacy key
    sessionStorage.setItem("pending_fields", JSON.stringify(fields));

    // USER NOT LOGGED IN ‚Üí Save to Django session + open modal
    if (!{{ user.is_authenticated|yesno:"true,false" }}) {

        console.log("üìå SENDING pending_fields TO SERVER:", fields);

        const resp = await fetch(`/${country}/${slug}/store-pending-fields/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRF(),
            },
            body: JSON.stringify({
                fields_data: fields,
                form_slug: slug
            })
        });

        console.log("üìå SERVER RESPONSE store-pending:", resp.status);

        try {
            const data = await resp.json();
            console.log("üìå SERVER JSON store-pending:", data);
        } catch (e) {
            console.log("üìå Could not parse JSON:", e);
        }

        openAuthModal();
        return;
    }

    // LOGGED IN ‚Üí Save to database
    await fetch(`/${country}/${slug}/save-fields/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRF(),
        },
        body: JSON.stringify({ fields_data: fields })
    });

    const res = await fetch(`/${country}/${slug}/has-paid/`);
    const data = await res.json();

    if (data.has_paid) {
        downloadFilledPDF();
    } else {
        pendingPaymentCountry = country;
        pendingPaymentSlug = slug;
        openPaymentModal();
    }
}
</script>

<script>
    async function proceedPayment() {
        closePaymentModal();
    
        const country = pendingPaymentCountry;
        const slug = pendingPaymentSlug;
    
        const res = await fetch(`/${country}/${slug}/create-checkout-session/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            }
        });
    
        const data = await res.json();
    
        const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
    
        await stripe.redirectToCheckout({ sessionId: data.id });
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
    
        if (urlParams.get("paid") === "1") {
    
            console.log("Payment complete ‚Üí showing success modal");
    
            // Remove ?paid=1 so modal does not appear again
            window.history.replaceState({}, "", window.location.pathname);
    
            // Show success modal
            openSuccessModal();
        }
    });
</script>
    
<script>
    function downloadWithSpinner() {
        const btn = document.getElementById("success-download-btn");
    
        // Save original label
        const originalHTML = btn.innerHTML;
    
        // Show spinner + message
        btn.innerHTML = `
            <span class="download-spinner"></span> &nbsp; Wird vorbereitet...
        `;
        btn.disabled = true;
    
        // Trigger real PDF download
        downloadFilledPDF();
    
        // Keep spinner for 30 seconds
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }, 30000); // 30,000 ms = 30 seconds
    }
</script>

<!-- üîÅ Restore fields function (used after PDF/overlays are ready) -->
<script>
function restoreFieldsFromStorage() {
    const country = "{{ country_code }}";
    const slug = "{{ form_info.slug }}";
    const storageKey = `pending_fields_${country}_${slug}`;

    let raw = sessionStorage.getItem(storageKey);

    if (!raw) {
        // fallback to legacy key if used earlier
        raw = sessionStorage.getItem("pending_fields");
    }

    if (!raw) {
        console.log("‚ÑπÔ∏è No pending fields in sessionStorage");
        return;
    }

    let fields = {};
    try {
        fields = JSON.parse(raw);
    } catch (e) {
        console.log("‚ö†Ô∏è Could not parse pending fields from sessionStorage:", e);
        return;
    }

    console.log("üîÅ Restoring fields from sessionStorage:", fields);

    // Text inputs (including signature)
    document.querySelectorAll('#pdf-pages input[type="text"]').forEach(input => {
        const name = input.dataset.name;
        if (!name) return;
        if (Object.prototype.hasOwnProperty.call(fields, name)) {
            input.value = fields[name] || "";
        }
    });

    // Checkboxes
    document.querySelectorAll('#pdf-pages .checkbox').forEach(box => {
        const name = box.dataset.name;
        if (!name) return;

        const val = fields[name];
        const checked = (val === "1" || val === 1 || val === true);

        if (checked) {
            box.dataset.checked = "1";
            box.classList.add("checked");
            box.textContent = "‚úì";
        } else {
            box.classList.remove("checked");
        }
    });
}






</script>

        
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("#pdf-pages .checkbox").forEach(box => {
    
            // Toggle checkbox on click
            box.addEventListener("click", (e) => {
                e.stopPropagation();
    
                const isChecked = box.dataset.checked === "1";
    
                if (isChecked) {
                    box.dataset.checked = "0";
                    box.classList.remove("checked");
                    box.textContent = "";
                } else {
                    box.dataset.checked = "1";
                    box.classList.add("checked");
                    box.textContent = "‚úì";
                }
            });
        });
    });
    </script>
    
  
   </main>

{% endblock %}
