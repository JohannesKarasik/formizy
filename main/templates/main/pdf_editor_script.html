{% load static %}


<style>
    :root{
      --bg:#0b1220;            /* dark chrome for editor chrome */
      --panel:#0f172a;
      --surface:#111827;
      --canvas-bg:#f8fafc;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#1f2937;
      --primary:#3b82f6;
      --primary-600:#2563eb;
      --primary-700:#1d4ed8;
      --success:#22c55e;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(2,6,23,.35);
      --radius:12px;
      --toolbar-h:56px;
      --subbar-h:44px;
      --sidebar-w:220px;
      --rightbar-w:280px;
    }
    html,body{margin:0;padding:0;background:var(--panel);color:var(--text);font-family:Inter,ui-sans-serif,system-ui;}
    main{padding:0;max-width:none}
  
    /* ===== App Shell ===== */
    .editor-shell{
      display:grid;
      grid-template-rows: var(--toolbar-h) var(--subbar-h) 1fr;
      grid-template-columns: var(--sidebar-w) 1fr var(--rightbar-w);
      grid-template-areas:
        "topbar topbar topbar"
        "subbar subbar subbar"
        "left   center right";
      height:100vh;
      overflow:hidden;
    }
  
    /* Top App Bar */
    .appbar{
      grid-area: topbar;
      display:flex;align-items:center;gap:16px;
      padding:0 16px;
      background:linear-gradient(180deg,#0b1220,#0b1220);
      border-bottom:1px solid var(--border);
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:700;
      letter-spacing:.2px;
    }
    .brand-badge{
      width:28px;height:28px;border-radius:8px;background:#0ea5e9;
      display:grid;place-items:center;color:white;font-weight:800;
      box-shadow:inset 0 0 10px rgba(255,255,255,.15);
    }
    .filename{color:#cbd5e1;font-weight:600}
    .appbar-actions{margin-left:auto;display:flex;align-items:center;gap:8px}
    .btn{
      height:36px;padding:0 12px;border-radius:8px;border:1px solid var(--border);
      background:#0b1220;color:#e5e7eb;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;
    }
    .btn-primary{background:linear-gradient(180deg,var(--primary),var(--primary-600));border-color:transparent;color:white}
    .btn-ghost{background:transparent}
    .btn:focus-visible{outline:2px solid #93c5fd;outline-offset:2px}
    .kbd{background:#111827;border:1px solid #1f2937;border-radius:6px;padding:2px 6px;font-size:12px;color:#9ca3af}
  
    /* Sub toolbar (tools & zoom) */
    .subbar{
      grid-area: subbar;
      display:flex;align-items:center;gap:14px;padding:0 12px;background:#0c162b;border-bottom:1px solid var(--border);
    }
    .tool-group{display:flex;align-items:center;gap:6px;background:#0b1427;border:1px solid var(--border);padding:4px;border-radius:10px}
    .tbtn{
      min-width:34px;height:32px;border:none;border-radius:8px;background:transparent;color:#cbd5e1;display:inline-flex;align-items:center;justify-content:center;padding:0 10px;gap:8px;cursor:pointer;
    }
    .tbtn[aria-pressed="true"], .tbtn.active{background:#172036;color:#fff}
    .sep{width:1px;height:24px;background:#1f2937;margin:0 6px}
    .zoom-readout{min-width:56px;text-align:center;color:#cbd5e1;font-size:12px}
    .zoom-slider{width:160px;appearance:none;height:6px;border-radius:8px;background:#1f2937;outline:none}
    .zoom-slider::-webkit-slider-thumb{appearance:none;height:16px;width:16px;border-radius:50%;background:#3b82f6;border:2px solid #93c5fd}
  
    /* Left thumbnails */
    .sidebar{
      grid-area: left;background:#0c162b;border-right:1px solid var(--border);overflow:auto;padding:10px 8px;
    }
    .thumb{background:#0b1427;border:1px solid #1f2937;border-radius:8px;padding:8px;margin-bottom:10px;cursor:pointer;transition:transform .08s}
    .thumb:hover{transform:translateY(-2px)}
    .thumb canvas{width:100%;height:auto;display:block;border-radius:4px;background:white}
    .thumb-label{font-size:12px;color:#9aa5b1;margin-top:6px;text-align:center}
  
    /* Center viewer */
    .viewer{
      grid-area: center; background:var(--surface); display:grid;grid-template-rows:auto 1fr;overflow:hidden;
    }
    .viewer-frame{
      height:100%;
      margin:0;
      border-radius:0;
      border-left:1px solid var(--border);
      border-right:1px solid var(--border);
      box-shadow:none;
      background:var(--surface);
    }
    #pdf-scroll{
      height:100%;
      overflow:auto;
      background:var(--canvas-bg);
      padding:24px 0;
    }
    #pdf-container{transform-origin:top center;margin:0 auto;display:block}
    #pdf-pages canvas{display:block;margin:0 auto 20px auto;box-shadow:0 10px 35px rgba(2,6,23,.18);border-radius:6px;background:white}
  
    /* Overlay fields */
    #pdf-container input[type="text"]{
      border:1px solid rgba(59,130,246,.35);
      background:rgba(59,130,246,.10);
      border-radius:6px;
      padding:6px 8px;
      font-size:14px;color:#0b1220;
    }
    .checkbox{
      border-radius:6px;background:rgba(59,130,246,.10);
      border:1px dashed rgba(59,130,246,.55);
      width:auto;height:auto;min-width:20px;min-height:20px;
    }
    .checkbox.checked{background:#10b98122;border-color:#10b981;color:#064e3b}
  
    /* Signature input stays from your CSS but with subtle lift */
    .signature-input{border:1px dashed rgba(124,58,237,.7);background:rgba(248,250,252,.95);border-radius:8px}
  
    /* Right rail (Properties/Help) */
    .rightbar{
      grid-area: right;background:#0c162b;border-left:1px solid var(--border);padding:14px;overflow:auto;
    }
    .rightbar h3{margin:4px 0 10px 0;font-size:14px;color:#cbd5e1}
    .prop{
      background:#0b1427;border:1px solid #1f2937;border-radius:10px;padding:12px;margin-bottom:12px;color:#cbd5e1;font-size:13px;
    }
    .prop label{display:block;font-size:12px;color:#94a3b8;margin-bottom:6px}
    .prop .field{display:flex;gap:8px;align-items:center}
    .prop input[type="text"], .prop select{
      width:100%;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:8px 10px;color:#e5e7eb
    }
  
    /* Fullscreen button minimal */
    #fullscreen-btn{
      position:fixed;right:14px;bottom:14px;padding:8px 12px;background:#111827cc;color:#fff;border-radius:8px;backdrop-filter:blur(6px);z-index:9999;opacity:.9
    }
  
    /* pan mode cursor */
    .pan-mode #pdf-scroll{cursor:grab}
    .pan-mode #pdf-scroll.is-panning{cursor:grabbing}
  
    @media (max-width: 1100px){
      :root{--rightbar-w:0px}
      .rightbar{display:none}
    }
    @media (max-width: 860px){
      :root{--sidebar-w:0px}
      .sidebar{display:none}
    }
  </style>
  

{# PDF.js #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<div class="editor-shell">

    <!-- Top App Bar -->
    <div class="appbar" role="toolbar" aria-label="PDF editor top bar">
      <div class="brand">
        <div class="brand-badge">PDF</div>
        <div class="filename">PDF-Editor</div>
      </div>
  
      <div class="appbar-actions">
        <button type="button" class="btn btn-ghost" id="btn-print" title="Print"><span>üñ®Ô∏è</span> Print</button>
        <button type="button" class="btn btn-ghost" id="btn-highlight" aria-pressed="false" title="Highlight form fields">üü¶ Fields</button>
  
        {% if not user.is_authenticated %}
          <button type="button" class="btn btn-primary" onclick="saveFieldsAndOpenAuth()">
            ‚¨áÔ∏è {{ lang.download_pdf|default:"PDF herunterladen" }} <span class="kbd">‚åò/Ctrl</span><span class="kbd">S</span>
          </button>
        {% else %}
          <button type="button" class="btn btn-primary" onclick="saveFieldsAndDownload()">
            ‚¨áÔ∏è {{ lang.download_pdf|default:"PDF herunterladen" }} <span class="kbd">‚åò/Ctrl</span><span class="kbd">S</span>
          </button>
        {% endif %}
      </div>
    </div>
  
    <!-- Tools / Zoom subbar -->
    <div class="subbar" role="toolbar" aria-label="Tools">
      <div class="tool-group" role="group" aria-label="Navigation">
        <button class="tbtn" id="tool-hand" aria-pressed="true" title="Pan (H)">‚úã Hand</button>
        <div class="sep"></div>
        <button class="tbtn" id="fit-width"  title="Fit to width (W)">‚ÜîÔ∏é Fit width</button>
        <button class="tbtn" id="fit-page"   title="Fit to page (P)">‚¨ö Fit page</button>
      </div>
  
      <div class="tool-group" role="group" aria-label="Form tools">
        <button class="tbtn" disabled title="Text field (from schema)">T</button>
        <button class="tbtn" disabled title="Checkbox (from schema)">‚òëÔ∏é</button>
        <button class="tbtn" disabled title="Signature (click a signature field)">‚úíÔ∏é</button>
        <button class="tbtn" disabled title="Code cells">#</button>
        <!-- kept disabled since fields come from your schema; UI is here for professional feel -->
      </div>
  
      <div class="tool-group" role="group" aria-label="Zoom">
        <button class="tbtn" id="zoom-out" title="Zoom out (‚Äì)">‚àí</button>
        <div class="zoom-readout" id="zoom-label">100%</div>
        <button class="tbtn" id="zoom-in" title="Zoom in (+)">+</button>
        <input type="range" id="zoom-slider" class="zoom-slider" min="50" max="200" step="5" value="100" aria-label="Zoom slider">
      </div>
  
      <div class="tool-group" role="group" aria-label="Pages">
        <button class="tbtn" id="prev-page" title="Previous page (PageUp)">‚óÄ</button>
        <div class="zoom-readout" id="page-readout">1 / 1</div>
        <button class="tbtn" id="next-page" title="Next page (PageDown)">‚ñ∂</button>
      </div>
    </div>
  
    <!-- Left: thumbnails -->
    <aside class="sidebar" id="thumbs-panel" aria-label="Page thumbnails"></aside>
  
    <!-- Center: your existing viewer frame (kept) -->
    <div class="viewer">
      <div class="viewer-frame">
        <div id="pdf-scroll">
          <div id="pdf-container">
            <div id="pdf-pages">
              {# your overlay fields block is untouched ‚Üì‚Üì‚Üì #}
              {% if form_info.fields_schema %}
                {% for field in form_info.fields_schema %}
                  {% if field.type == "checkbox" %}
                    <div class="checkbox"
                         data-name="{{ field.name }}"
                         data-page="{{ field.page|default:1 }}"
                         data-px="{{ field.pixel_x }}"
                         data-py="{{ field.pixel_y }}"
                         data-pw="{{ field.pixel_width }}"
                         data-ph="{{ field.pixel_height }}">
                    </div>
                  {% elif field.type == "signature" %}
                    <input type="text"
                           class="signature-input"
                           placeholder="{{ lang.sig_placeholder }}"
                           data-name="{{ field.name }}"
                           data-page="{{ field.page|default:1 }}"
                           data-px="{{ field.pixel_x }}"
                           data-py="{{ field.pixel_y }}"
                           data-pw="{{ field.pixel_width }}"
                           data-ph="{{ field.pixel_height }}">
                  {% elif field.type == "code" %}
                    <div class="code-input"
                         data-name="{{ field.name }}"
                         data-page="{{ field.page }}"
                         data-px="{{ field.pixel_x }}"
                         data-py="{{ field.pixel_y }}"
                         data-pw="{{ field.pixel_width }}"
                         data-ph="{{ field.pixel_height }}"
                         data-digits="{{ field.digits }}">
                    </div>
                  {% else %}
                    <input type="text"
                           data-name="{{ field.name }}"
                           data-page="{{ field.page|default:1 }}"
                           data-px="{{ field.pixel_x }}"
                           data-py="{{ field.pixel_y }}"
                           data-pw="{{ field.pixel_width }}"
                           data-ph="{{ field.pixel_height }}">
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Right: properties/help -->
    <aside class="rightbar">
      <h3>{{ lang.properties|default:"Properties" }}</h3>
      <div class="prop">
        <label>{{ lang.zoom|default:"Zoom" }}</label>
        <div class="field"><span id="prop-zoom">100%</span></div>
      </div>
      <div class="prop">
        <label>{{ lang.shortcuts|default:"Shortcuts" }}</label>
        <div>
          <div><span class="kbd">‚åò/Ctrl</span> + <span class="kbd">S</span> ‚Äî {{ lang.download_pdf|default:"Download" }}</div>
          <div><span class="kbd">+</span>/<span class="kbd">‚àí</span> ‚Äî Zoom</div>
          <div><span class="kbd">W</span>/<span class="kbd">P</span> ‚Äî Fit width / page</div>
          <div><span class="kbd">H</span> ‚Äî Hand tool</div>
          <div><span class="kbd">PgUp</span>/<span class="kbd">PgDn</span> ‚Äî Prev/Next page</div>
        </div>
      </div>
      <div class="prop">
        <label>{{ lang.help|default:"Help" }}</label>
        <p style="margin:6px 0;color:#94a3b8;font-size:12px">
          {{ lang.help_text|default:"Click fields to type. Click signature fields to open the signature modal." }}
        </p>
      </div>
    </aside>
  </div>
  
  <!-- Keep your fullscreen + payment + signature modals as-is -->
  <div id="fullscreen-btn">
    ‚§¢ {{ lang.fullscreen }}
  </div>
  
  <script>
    /* ========= Professional controls wiring (non-breaking) ========= */
    (function(){
      const scrollEl = document.getElementById('pdf-scroll');
      const pagesContainer = document.getElementById('pdf-pages');
      const thumbsPanel = document.getElementById('thumbs-panel');
      const zoomSlider = document.getElementById('zoom-slider');
      const zoomLabel  = document.getElementById('zoom-label');
      const propZoom   = document.getElementById('prop-zoom');
      const pageReadout= document.getElementById('page-readout');
      const btnZoomIn  = document.getElementById('zoom-in');
      const btnZoomOut = document.getElementById('zoom-out');
      const btnFitW    = document.getElementById('fit-width');
      const btnFitP    = document.getElementById('fit-page');
      const btnPrev    = document.getElementById('prev-page');
      const btnNext    = document.getElementById('next-page');
      const btnHand    = document.getElementById('tool-hand');
      const btnHighlight = document.getElementById('btn-highlight');
      const btnPrint   = document.getElementById('btn-print');
    
      let totalPages = 1;
      let currentPage = 1;
      let pageCanvases = [];
    
      // Hook into your existing PDF render to build thumbnails
      const _origRender = pdfjsLib.getDocument; // not overriding, just using lifecycle below
    
      // After the document loads (your code already renders canvases), wait a tick and grab them
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          pageCanvases = Array.from(document.querySelectorAll('#pdf-pages canvas'));
          if (pageCanvases.length) {
            totalPages = pageCanvases.length;
            pageReadout.textContent = `1 / ${totalPages}`;
            buildThumbnails(pageCanvases);
            indexPageOffsets();
          }
        }, 800);
      });
    
      // Thumbnails
      function buildThumbnails(canvases){
        thumbsPanel.innerHTML = '';
        canvases.forEach((cv,i)=>{
          const wrap = document.createElement('div');
          wrap.className = 'thumb';
          const small = document.createElement('canvas');
          const ratio = 150 / cv.width;
          small.width = 150;
          small.height = Math.round(cv.height * ratio);
          small.getContext('2d').drawImage(cv,0,0,small.width,small.height);
          const lbl = document.createElement('div');
          lbl.className = 'thumb-label';
          lbl.textContent = `Page ${i+1}`;
          wrap.appendChild(small); wrap.appendChild(lbl);
          wrap.addEventListener('click',()=>scrollToPage(i+1));
          thumbsPanel.appendChild(wrap);
        });
      }
    
      // Page navigation helpers
      let pageOffsets = [];
      function indexPageOffsets(){
        pageOffsets = pageCanvases.map(cv => ({
          top: cv.offsetTop,
          height: cv.offsetHeight
        }));
      }
      function scrollToPage(n){
        n = Math.max(1, Math.min(totalPages, n));
        const off = pageOffsets[n-1]?.top || 0;
        scrollEl.scrollTo({top: off - 20, behavior:'smooth'});
      }
      function detectCurrentPage(){
        const y = scrollEl.scrollTop + 60;
        let idx = 0;
        for (let i=0;i<pageOffsets.length;i++){
          if (y < pageOffsets[i].top + pageOffsets[i].height) { idx = i; break; }
        }
        currentPage = idx+1 || 1;
        pageReadout.textContent = `${currentPage} / ${totalPages}`;
      }
      scrollEl?.addEventListener('scroll', ()=>{ detectCurrentPage(); });
    
      // Zoom: keep your applyZoom; sync slider + labels
      function syncZoomUI(){
        const pct = Math.round((window.currentZoom || 1) * 100);
        zoomSlider.value = pct;
        zoomLabel.textContent = pct + '%';
        if (propZoom) propZoom.textContent = zoomLabel.textContent;
      }
      const _applyZoom = window.applyZoom;
      window.applyZoom = function(){
        _applyZoom && _applyZoom();
        syncZoomUI();
        // Reposition overlays after transforms
        const canvases = document.querySelectorAll("#pdf-pages canvas");
        positionOverlays(Array.from(canvases));
      }
      btnZoomIn?.addEventListener('click', ()=>{ zoomIn(); });
      btnZoomOut?.addEventListener('click', ()=>{ zoomOut(); });
      zoomSlider?.addEventListener('input', ()=>{
        window.currentZoom = Math.max(.5, Math.min(2.0, zoomSlider.value/100));
        applyZoom();
      });
    
      // Fit to width / page
      function fitWidth(){
        const container = document.getElementById('pdf-container');
        const avail = document.querySelector('.viewer-frame').clientWidth - 48; // padding
        const sample = pageCanvases[0];
        if (!sample) return;
        // current canvas width is FIXED_WIDTH; we transform container
        const target = avail / (sample.width);
        window.currentZoom = Math.max(.5, Math.min(2.0, target));
        applyZoom();
      }
      function fitPage(){
        const availW = document.querySelector('.viewer-frame').clientWidth - 48;
        const availH = document.getElementById('pdf-scroll').clientHeight - 48;
        const sample = pageCanvases[0];
        if (!sample) return;
        const scaleW = availW / sample.width;
        const scaleH = availH / sample.height;
        window.currentZoom = Math.max(.5, Math.min(2.0, Math.min(scaleW, scaleH)));
        applyZoom();
      }
      btnFitW?.addEventListener('click', fitWidth);
      btnFitP?.addEventListener('click', fitPage);
    
      // Prev/Next
      btnPrev?.addEventListener('click', ()=>scrollToPage(currentPage-1));
      btnNext?.addEventListener('click', ()=>scrollToPage(currentPage+1));
    
      // Hand (pan) tool: drag to scroll
      let isPanning=false, startY=0, startX=0, startScrollTop=0, startScrollLeft=0;
      function setHand(active){
        document.body.classList.toggle('pan-mode', !!active);
        btnHand.setAttribute('aria-pressed', active ? 'true' : 'false');
      }
      setHand(true);
      btnHand?.addEventListener('click', ()=> setHand(btnHand.getAttribute('aria-pressed')!=='true'));
      scrollEl?.addEventListener('mousedown',(e)=>{
        if (document.body.classList.contains('pan-mode')){
          isPanning=true; startY=e.clientY; startX=e.clientX;
          startScrollTop=scrollEl.scrollTop; startScrollLeft=scrollEl.scrollLeft;
          scrollEl.classList.add('is-panning');
        }
      });
      window.addEventListener('mousemove',(e)=>{
        if (!isPanning) return;
        scrollEl.scrollTop = startScrollTop - (e.clientY - startY);
        scrollEl.scrollLeft= startScrollLeft- (e.clientX - startX);
      });
      window.addEventListener('mouseup',()=>{ isPanning=false; scrollEl.classList.remove('is-panning'); });
    
      // Highlight fields toggle
      btnHighlight?.addEventListener('click', ()=>{
        const pressed = btnHighlight.getAttribute('aria-pressed')==='true';
        btnHighlight.setAttribute('aria-pressed', (!pressed).toString());
        const on = !pressed;
        document.querySelectorAll('#pdf-container input[type="text"], #pdf-container .checkbox, #pdf-container .signature-input')
          .forEach(el=>{
            el.style.outline = on ? '2px solid rgba(59,130,246,.65)' : '';
            el.style.boxShadow = on ? '0 0 0 3px rgba(59,130,246,.18)' : '';
          });
      });
    
      // Print (renders current canvas images to a print-friendly window)
      btnPrint?.addEventListener('click', ()=>{
        const w = window.open('','_blank');
        if (!w) return;
        w.document.write('<title>Print PDF</title><style>img{display:block;margin:0 0 12px 0;width:100%}</style>');
        pageCanvases.forEach(cv=>{
          w.document.write(`<img src="${cv.toDataURL('image/png')}" />`);
        });
        w.document.close(); w.focus(); w.print();
      });
    
      // Keyboard shortcuts
      window.addEventListener('keydown',(e)=>{
        const key = e.key.toLowerCase();
        if ((e.ctrlKey||e.metaKey) && key==='s'){ e.preventDefault(); 
          {% if not user.is_authenticated %} saveFieldsAndOpenAuth(); {% else %} saveFieldsAndDownload(); {% endif %}
        }
        if (key==='+' || (e.shiftKey && key==='=')){ e.preventDefault(); zoomIn(); }
        if (key==='-' ){ e.preventDefault(); zoomOut(); }
        if (key==='w'){ e.preventDefault(); fitWidth(); }
        if (key==='p'){ e.preventDefault(); fitPage(); }
        if (key==='h'){ e.preventDefault(); setHand(true); }
        if (e.key==='PageUp'){ e.preventDefault(); scrollToPage(currentPage-1); }
        if (e.key==='PageDown'){ e.preventDefault(); scrollToPage(currentPage+1); }
      });
    
      // Re-index on resize/fullscreen
      window.addEventListener('resize',()=>{ indexPageOffsets(); });
      document.addEventListener('fullscreenchange',()=>{ setTimeout(()=>{ indexPageOffsets(); }, 200); });
    
    })();
    </script>
    