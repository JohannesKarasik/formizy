<style>
  /* =======================
     AUTH MODAL (IMPROVED)
  ======================= */
  #auth-modal.auth-modal-hidden {
    display: none;
  }

  #auth-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
  }

  .auth-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(3px);
  }

  .auth-box {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 92%;
    max-width: 420px;
    
    background: #ffffff;
    border-radius: 18px;
    padding: 36px 34px; /* more vertical padding */
    
    box-shadow: 0 14px 60px rgba(0,0,0,0.18);

    animation: fadeInScale .25s ease-out;

    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 22px; /* consistent spacing */
  }

  @keyframes fadeInScale {
    from { opacity:0; transform:translate(-50%, -52%) scale(0.95); }
    to   { opacity:1; transform:translate(-50%, -50%) scale(1); }
  }

  /* Close button */
  .auth-close {
    position: absolute;
    top: 14px;
    right: 14px;
    background: none;
    border: none;
    font-size: 26px;
    font-weight: 400;
    color: #444;
    cursor: pointer;
    transition: 0.2s;
  }

  .auth-close:hover {
    opacity: 0.6;
  }

  /* Title */
  .auth-box h2 {
    margin: 0;
    margin-bottom: 6px;
    font-size: 1.7rem;
    font-weight: 700;
    color: #0b1225;
    text-align: center;
  }

  /* Inputs */
  #auth-modal input {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid #d6dae6;
    background: #f3f6ff;
    font-size: 15px;
    transition: 0.15s;
    height: 48px;            /* smaller height */
  }

  #auth-modal input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
    background: #ffffff;
  }

  /* Buttons */
  .auth-btn-primary {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: none;
    background: #2563eb;
    color: white;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: 0.15s;
    height: 48px;
  }

  .auth-btn-primary:hover {
    background: #1d4ed8;
  }

  /* Switch text */
  .auth-switch {
    text-align: center;
    margin-top: 4px;
    color: #555;
    font-size: 0.95rem;
  }

  .auth-switch-btn {
    background: none;
    border: none;
    color: #2563eb;
    cursor: pointer;
    font-weight: 600;
    margin-left: 6px;
    font-size: 0.96rem;
  }
</style>


<div class="auth-box">
  <button class="auth-close" onclick="closeAuthModal()">Ã—</button>

  <!-- CSRF token -->
  <form style="display:none;">{% csrf_token %}</form>

  <h2 id="auth-title">Log in</h2>

  <!-- LOGIN FORM -->
  <form id="login-form" onsubmit="handleLogin(event)" style="width:100%;">
    <input type="email" id="login-email" placeholder="Email" required>
    <input type="password" id="login-password" placeholder="Password" required>
    <button type="submit" class="auth-btn-primary">Log in</button>
  </form>

  <!-- REGISTER FORM -->
  <form id="register-form" onsubmit="handleRegister(event)" style="display:none; width:100%;">
    <input type="email" id="register-email" placeholder="Email" required>
    <input type="password" id="register-password" placeholder="Create password" required>
    <button type="submit" class="auth-btn-primary">Create account</button>
  </form>

  <p class="auth-switch">
    <span id="switch-text">No account?</span>
    <button class="auth-switch-btn" onclick="toggleAuth()">Create one</button>
  </p>
</div>


<script>
function openAuthModal() {
  document.getElementById("auth-modal").classList.remove("auth-modal-hidden");
}

function closeAuthModal() {
  document.getElementById("auth-modal").classList.add("auth-modal-hidden");
}

function toggleAuth() {
  const login = document.getElementById("login-form");
  const reg = document.getElementById("register-form");
  const title = document.getElementById("auth-title");
  const switchText = document.getElementById("switch-text");
  const switchBtn = document.querySelector(".auth-switch-btn");

  if (login.style.display !== "none") {
      login.style.display = "none";
      reg.style.display = "block";
      title.textContent = "Create account";
      switchText.textContent = "Already have an account?";
      switchBtn.textContent = "Log in";
  } else {
      login.style.display = "block";
      reg.style.display = "none";
      title.textContent = "Log in";
      switchText.textContent = "No account?";
      switchBtn.textContent = "Create one";
  }
}
</script>

<script>
async function handleLogin(event) {
  event.preventDefault();

  const email = document.getElementById("login-email").value;
  const password = document.getElementById("login-password").value;

  const res = await fetch("/login/", {
      method: "POST",
      headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCSRF(),
      },
      body: new URLSearchParams({
          email: email,
          password: password,
          next: window.location.pathname
      })
  });

  if (res.redirected) {
      window.location = res.url;   
      return;
  }

  alert("Login failed. Check your email or password.");
}


async function handleRegister(event) {
  event.preventDefault();

  const email = document.getElementById("register-email").value;
  const password = document.getElementById("register-password").value;

  const formData = new FormData();
  formData.append("email", email);
  formData.append("password", password);
  formData.append("next", window.location.pathname);

  const res = await fetch("/register/", {
      method: "POST",
      headers: {
          "X-CSRFToken": getCSRF(),
      },
      body: formData
  });

  const text = await res.text();
  console.log("RAW RESPONSE:", text);

  try {
      const data = JSON.parse(text);
      if (!res.ok) {
          alert("Registration failed: " + data.error);
          return;
      }
      window.location = data.next;
  } catch (err) {
      console.error("JSON parse error:", err);
      alert("Server returned HTML instead of JSON. Check backend.");
  }
}


function getCSRF() {
  return document.querySelector("[name=csrfmiddlewaretoken]")?.value;
}
</script>
