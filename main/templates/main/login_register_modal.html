{% if country_code == "de" %}
    {% include "main/lang/de.html" %}
{% elif country_code == "es" %}
    {% include "main/lang/es.html" %}
{% else %}
    {% include "main/lang/en.html" %}
{% endif %}



<style>
  /* =======================
     AUTH MODAL (FULL)
  ======================= */
  #auth-modal.auth-modal-hidden {
    display: none;
  }

  #auth-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 9999;
  }

  .auth-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(3px);
  }

  .auth-box {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 420px;
    padding: 28px;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 8px 40px rgba(0,0,0,0.15);
    animation: fadeInScale .25s ease-out;

    display: flex;
    flex-direction: column;
    justify-content: center;  
    align-items: center;
    min-height: 320px;
  }

  @keyframes fadeInScale {
    from {opacity: 0; transform: translate(-50%, -48%) scale(0.95);}
    to   {opacity: 1; transform: translate(-50%, -50%) scale(1);}
  }

  .auth-close {
    position: absolute;
    top: 12px; right: 12px;
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
  }

  #auth-modal input {
    width: 100%;
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #d4d7e2;
    font-size: 15px;
  }

  .auth-btn-primary {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    background: #2563eb;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    font-size: 16px;
  }

  .auth-switch {
    text-align: center;
    margin-top: 24px !important;
    color: #555;
  }

  .auth-switch-btn {
    background: none;
    border: none;
    color: #2563eb;
    cursor: pointer;
    font-weight: 600;
  }
</style>




<div id="auth-modal" class="auth-modal-hidden">
  <div class="auth-backdrop" onclick="closeAuthModal()"></div>

  <div class="auth-box">
    <button class="auth-close" onclick="closeAuthModal()">Ã—</button>

    <form style="display:none;">{% csrf_token %}</form>

    <h2 id="auth-title">{{ lang.login_title }}</h2>

    <!-- LOGIN FORM -->
    <form id="login-form"
          onsubmit="handleLogin(event)"
          style="display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%; gap:12px;">

      <input type="email" id="login-email" placeholder="{{ lang.email }}" required style="width:95%;">
      <input type="password" id="login-password" placeholder="{{ lang.password }}" required style="width:95%;">
      <button type="submit" class="auth-btn-primary" style="margin-bottom: 12px;">{{ lang.login_btn }}</button>
    </form>

    <!-- REGISTER FORM -->
    <form id="register-form"
          style="display:none; flex-direction:column; justify-content:center; align-items:center; width:100%; gap:12px;"
          onsubmit="handleRegister(event)">

      <input type="email" id="register-email" placeholder="{{ lang.email }}" required style="width:95%;">
      <input type="password" id="register-password" placeholder="{{ lang.password_create }}" required style="width:95%;">
      <button type="submit" class="auth-btn-primary">{{ lang.register_btn }}</button>
    </form>

    <p class="auth-switch">
      <span id="switch-text">{{ lang.no_account }}</span>
      <button class="auth-switch-btn" onclick="toggleAuth()">{{ lang.switch_register }}</button>
    </p>

  </div>
</div>






<script>
/* ===============================================
   OPEN MODAL (defaults to REGISTER view)
=============================================== */
function openAuthModal() {
    const modal = document.getElementById("auth-modal");
    modal.classList.remove("auth-modal-hidden");

    toggleToRegister();
}

function closeAuthModal() {
    document.getElementById("auth-modal").classList.add("auth-modal-hidden");
}



/* ===============================================
   TOGGLE LOGIN <-> REGISTER
=============================================== */

function toggleToRegister() {
    login.style.display = "none";
    reg.style.display = "flex";

    title.textContent = "{{ lang.register_title }}";
    switchText.textContent = "{{ lang.yes_account }}";
    switchBtn.textContent = "{{ lang.switch_login }}";
}

function toggleToLogin() {
    login.style.display = "flex";
    reg.style.display = "none";

    title.textContent = "{{ lang.login_title }}";
    switchText.textContent = "{{ lang.no_account }}";
    switchBtn.textContent = "{{ lang.switch_register }}";
}

function toggleAuth() {
    if (login.style.display !== "none") toggleToRegister();
    else toggleToLogin();
}



const login = document.getElementById("login-form");
const reg = document.getElementById("register-form");
const title = document.getElementById("auth-title");
const switchText = document.getElementById("switch-text");
const switchBtn = document.querySelector(".auth-switch-btn");

/* ===============================================
   LOGIN
=============================================== */
async function handleLogin(event) {
    event.preventDefault();

    const email = document.getElementById("login-email").value;
    const password = document.getElementById("login-password").value;

    const res = await fetch("/login/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCSRF(),
        },
        body: new URLSearchParams({
            email: email,
            password: password,
            next: window.location.pathname
        })
    });

    if (res.redirected) {
        window.location = res.url;
        return;
    }

    alert("{{ lang.login_failed }}");
}



/* ===============================================
   REGISTER
=============================================== */
async function handleRegister(event) {
    event.preventDefault();

    const email = document.getElementById("register-email").value;
    const password = document.getElementById("register-password").value;

    const formData = new FormData();
    formData.append("email", email);
    formData.append("password", password);
    formData.append("next", window.location.pathname);

    const res = await fetch("/register/", {
        method: "POST",
        headers: {"X-CSRFToken": getCSRF()},
        body: formData
    });

    const text = await res.text();

    try {
        const data = JSON.parse(text);

        if (!res.ok) {
            alert("{{ lang.register_failed }}: " + data.error);
            return;
        }

        window.location = data.next;

    } catch (err) {
        console.error("JSON parse error:", err);
        alert("{{ lang.server_error }}");
    }
}

function getCSRF() {
  return document.querySelector("[name=csrfmiddlewaretoken]")?.value;
}
</script>

{% endwith %}
