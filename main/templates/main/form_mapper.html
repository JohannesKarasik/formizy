{% extends "main/base.html" %}


{% block title %}
   Map Fields ‚Äî {{ form_info.title }}
{% endblock %}


{% block content %}


   <h2 style="text-align:center;margin-top:20px;">
       üß≠ Map Form Fields: {{ form_info.title }}
   </h2>

   <p style="text-align:center;color:#555;">
       Drag boxes over fields and click ‚ÄúSave Layout‚Äù.
   </p>

   <div style="display:flex;justify-content:center;align-items:flex-start;gap:20px;margin-top:20px;">

       <!-- üß© MAPPING CANVAS -->
       <div id="pdf-container"
            style="position:relative; width:100%; display:inline-block;">
           <!-- canvases for each page are injected here -->
       </div>

       <!-- üìé SIDEBAR -->
       <div id="sidebar"
            style="position:sticky;top:100px;align-self:flex-start;
                   background:#f8f9fa;border:1px solid #ddd;border-radius:8px;
                   padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">

           <h4 style="margin-top:0;text-align:center;">‚öôÔ∏è Controls</h4>

           <button onclick="addField()"
                   style="display:block;width:100%;margin-bottom:10px;
                          padding:10px;border:none;border-radius:6px;
                          background:#0071e3;color:white;cursor:pointer;">
               ‚ûï Add Field
           </button>

           <button onclick="addSignature()"
        style="display:block;width:100%;margin-bottom:10px;
               padding:10px;border:none;border-radius:6px;
               background:#6b21a8;color:white;cursor:pointer;">
                ‚úçÔ∏è Add Signature Field
            </button>


           <button onclick="saveLayout()"
                   style="display:block;width:100%;padding:10px;
                          border:none;border-radius:6px;
                          background:#28a745;color:white;cursor:pointer;">
               üíæ Save Layout
           </button>

       </div>

   </div>

   <!-- PDF.js -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>


   <style>
    .delete-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 18px;
        height: 18px;
        background: #e11d48;
        color: white;
        border-radius: 50%;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
        cursor: pointer;
        z-index: 9999;
        display: none;
    }
    .draggable:hover .delete-btn {
        display: block;
    }
    </style>
    
   <script>

let mouseX = 200;
let mouseY = 200;

document.addEventListener("mousemove", (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
});

     /* ---------------------------- LOAD PDF INTO CANVAS ----------------------------- */

     const pdfUrl = "{{ form_info.pdf_file.url }}";
     const FIXED_WIDTH = 833;

     pdfjsLib.getDocument(pdfUrl).promise.then(async pdf => {

         window.mapperPdf = pdf;
         window.mapperScale = 1; // will update on first page

         const container = document.getElementById("pdf-container");

         for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
             const page = await pdf.getPage(pageNum);

             const viewport = page.getViewport({ scale: 1 });
             const scale = FIXED_WIDTH / viewport.width;

             if (pageNum === 1) {
                 // Save PDF.js ‚Üí Viewer scale (PDF width ‚Üí 833px)
                 window.mapperScale = scale;
                 window.mapperPdfWidth = viewport.width;
                 window.mapperPdfHeight = viewport.height;
             }

             const scaledViewport = page.getViewport({ scale });

             // Create a new canvas per page
             const pageCanvas = document.createElement("canvas");
             pageCanvas.width = FIXED_WIDTH;
             pageCanvas.height = scaledViewport.height;
             pageCanvas.style.width = FIXED_WIDTH + "px";
             pageCanvas.style.height = scaledViewport.height + "px";
             pageCanvas.style.display = "block";
             pageCanvas.style.marginBottom = "20px";
             pageCanvas.dataset.page = pageNum;

             // keep viewport so we *could* use it later if needed
             pageCanvas._pdfViewport = scaledViewport;

             container.appendChild(pageCanvas);

             await page.render({
                 canvasContext: pageCanvas.getContext("2d"),
                 viewport: scaledViewport
             }).promise;
             if (pageNum === pdf.numPages) {
            restoreSavedLayout();
        }
         }
     });

     /* ---------------------------- DRAGGABLE FIELD BOXES ----------------------------- */

     let fieldCount = 0;

     function addField() {

    fieldCount++;

    const box = document.createElement("div");
    box.className = "draggable";
    box.dataset.name = "field_" + fieldCount;
    box.textContent = "Field " + fieldCount;

    const del = document.createElement("div");
    del.className = "delete-btn";
    del.textContent = "√ó";
    del.onclick = () => {
    box.dataset.deleted = "1";   // mark as deleted
    box.remove();                // remove from screen
};
    box.appendChild(del);

    const container = document.getElementById("pdf-container");
    const cRect = container.getBoundingClientRect();
    const relLeft = mouseX - cRect.left;
    const relTop  = mouseY - cRect.top;

    Object.assign(box.style, {
        position: "absolute",
        left: relLeft + "px",
        top: relTop + "px",
        width: "160px",
        height: "28px",
        background: "rgba(255,255,255,0.8)",
        border: "2px dashed #0071e3",
        borderRadius: "4px",
        cursor: "move",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: "20",
    });

    container.appendChild(box);
    enableDrag(box);
    }



    function addCheckbox() {

fieldCount++;

const box = document.createElement("div");
box.className = "draggable checkbox-field";
box.dataset.type = "checkbox";
box.dataset.name = "checkbox_" + fieldCount;
box.dataset.checked = "0";
box.textContent = ""; // starts empty (unchecked)


const del = document.createElement("div");
del.className = "delete-btn";
del.textContent = "√ó";
del.onclick = () => {
    box.dataset.deleted = "1";   // mark as deleted
    box.remove();                // remove from screen
};
box.appendChild(del);

const container = document.getElementById("pdf-container");
const cRect = container.getBoundingClientRect();
const relLeft = mouseX - cRect.left;
const relTop  = mouseY - cRect.top;

Object.assign(box.style, {
    position: "absolute",
    left: relLeft + "px",
    top: relTop + "px",
    width: "18px",          // 25% smaller
    height: "18px",
    fontSize: "15px",  
    background: "rgba(37, 99, 235, 0.08)",   // match text fields
    border: "none",
    borderRadius: "4px",
    cursor: "pointer",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "20",
    fontSize: "20px",
    fontWeight: "bold",
    userSelect: "none",
});

// click toggles checked/unchecked
box.addEventListener("click", (e) => {
    e.stopPropagation(); // don't interfere with dragging
    const isChecked = box.dataset.checked === "1";
    if (isChecked) {
        box.dataset.checked = "0";
        box.textContent = "";
    } else {
        box.dataset.checked = "1";
        box.textContent = "‚úì";
    }
});

container.appendChild(box);
enableDrag(box);
}


function addSignature() {
    fieldCount++;

    const box = document.createElement("div");
    box.className = "draggable signature-field";
    box.dataset.type = "signature";                 // üîë important
    box.dataset.name = "signature_" + fieldCount;
    box.textContent = "Signature " + fieldCount;


    const del = document.createElement("div");
    del.className = "delete-btn";
    del.textContent = "√ó";
    del.onclick = () => {
    box.dataset.deleted = "1";   // mark as deleted
    box.remove();                // remove from screen
};
    box.appendChild(del);

    const container = document.getElementById("pdf-container");
    const cRect = container.getBoundingClientRect();
    const relLeft = mouseX - cRect.left;
    const relTop  = mouseY - cRect.top;

    Object.assign(box.style, {
        position: "absolute",
        left: relLeft + "px",
        top: relTop + "px",
        width: "200px",
        height: "32px",
        background: "rgba(255,255,255,0.9)",
        border: "2px dashed #6b21a8",
        borderRadius: "6px",
        cursor: "move",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        fontSize: "13px",
        fontWeight: "600",
        color: "#6b21a8",
        zIndex: "20",
    });

    container.appendChild(box);
    enableDrag(box);
}



     function enableDrag(el) {

         interact(el)
             .draggable({
                 listeners: {
                     move(event) {
                         let x =
                             (parseFloat(el.getAttribute("data-x")) || 0)
                             + event.dx;
                         let y =
                             (parseFloat(el.getAttribute("data-y")) || 0)
                             + event.dy;

                         el.style.transform =
                             `translate(${x}px,${y}px)`;

                         el.setAttribute("data-x", x);
                         el.setAttribute("data-y", y);
                     }
                 }
             })
             .resizable({
                 edges: { left:true, right:true, bottom:true, top:true }
             })
             .on("resizemove", event => {

                 let { x, y } = event.target.dataset;

                 x = parseFloat(x) || 0;
                 y = parseFloat(y) || 0;

                 Object.assign(event.target.style, {
                     width: `${event.rect.width}px`,
                     height: `${event.rect.height}px`,
                     transform:
                         `translate(${x + event.deltaRect.left}px,
                                    ${y + event.deltaRect.top}px)`
                 });

                 event.target.dataset.x =
                     x + event.deltaRect.left;

                 event.target.dataset.y =
                     y + event.deltaRect.top;
             });
     }

     /* ---------------------------- SAVE WITH PDF-SPACE COORDS ----------------------------- */

     function saveLayout() {

const items = [];
const container = document.getElementById("pdf-container");
const canvases = Array.from(container.querySelectorAll("canvas"));

document.querySelectorAll(".draggable").forEach(el => {
    // Base position from inline styles
    const baseLeft = parseFloat(el.style.left || "0");
    const baseTop  = parseFloat(el.style.top  || "0");

    // Interact.js translation (data-x / data-y)
    const dx = parseFloat(el.dataset.x || "0");
    const dy = parseFloat(el.dataset.y || "0");

    // Final absolute position inside #pdf-container
    const absLeft = baseLeft + dx;
    const absTop  = baseTop  + dy;

    const width  = el.offsetWidth;
    const height = el.offsetHeight;

    // Find the canvas (page) this field belongs to, using its vertical center
    const fieldCenterY = absTop + height / 2;
    let pageCanvas = null;

    for (const c of canvases) {
        const top    = c.offsetTop;
        const bottom = top + c.offsetHeight;
        if (fieldCenterY >= top && fieldCenterY <= bottom) {
            pageCanvas = c;
            break;
        }
    }

    if (!pageCanvas) {
        console.error("‚ùå Could not detect page canvas for field:", el.dataset.name);
        return;
    }

    // Position inside that canvas
    const canvasX = absLeft - pageCanvas.offsetLeft;
    const canvasY = absTop  - pageCanvas.offsetTop;

    // Store coords in unscaled PDF units
    const px = canvasX / window.mapperScale;
    const py = canvasY / window.mapperScale;
    const pw = width    / window.mapperScale;
    const ph = height   / window.mapperScale;

    items.push({
    name: el.dataset.name,
    type: el.dataset.type || "text",

    pixel_x: px,
    pixel_y: py,
    pixel_width: pw,
    pixel_height: ph,

    mapper_scale: window.mapperScale,
    page: parseInt(pageCanvas.dataset.page),

    checked: el.dataset.checked || "0"   // ‚úÖ SAVE CHECKED STATE
});

});

console.log("FINAL MAPPED FIELDS:", items);

fetch(window.location.href, {
    method: "POST",
    headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
    },
    body: JSON.stringify(items)
})
.then(r => r.json())
.then(data => alert("‚úÖ Saved " + data.count + " fields!"));
}

document.addEventListener("keydown", (e) => {

// cmd+d (Mac) or ctrl+d (Windows)
if ((e.metaKey || e.ctrlKey) && e.key === "d") {
    e.preventDefault();
    addField();
}

// cmd+f (Mac) or ctrl+f (Windows)
if ((e.metaKey || e.ctrlKey) && e.key === "f") {
    e.preventDefault();
    addCheckbox();
}
});


function restoreSavedLayout() {
    const saved = {{ form_info.fields_schema|safe }};
    if (!saved || saved.length === 0) {
        console.log("No saved fields to restore.");
        return;
    }

    console.log("Restoring saved fields‚Ä¶", saved);

    saved.forEach(f => {
        const box = document.createElement("div");
        box.className = "draggable";
        box.dataset.name = f.name;
        box.dataset.type = f.type;

        // Convert stored PDF coords back to viewer coords
        const px = f.pixel_x * window.mapperScale;
        const py = f.pixel_y * window.mapperScale;
        const pw = f.pixel_width * window.mapperScale;
        const ph = f.pixel_height * window.mapperScale;

        Object.assign(box.style, {
            position: "absolute",
            left: `${px}px`,
            top: `${py}px`,
            width: `${pw}px`,
            height: `${ph}px`,
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            zIndex: 20,
        });

        if (f.type === "checkbox") {
    box.classList.add("checkbox-field");

    // restore state
    box.dataset.checked = f.checked === "1" ? "1" : "0";
    box.textContent = f.checked === "1" ? "‚úì" : "";

    // click toggles check state
    box.addEventListener("click", (e) => {
        e.stopPropagation();
        const isChecked = box.dataset.checked === "1";
        box.dataset.checked = isChecked ? "0" : "1";
        box.textContent = isChecked ? "" : "‚úì";
    });
}

        else if (f.type === "signature") {
            box.classList.add("signature-field");
            box.textContent = "Signature";
            box.style.border = "2px dashed #6b21a8";
        }
        else {
            box.textContent = f.name;
            box.style.border = "2px dashed #0071e3";
            box.style.background = "rgba(255,255,255,0.8)";
        }

        // ADD DELETE BUTTON
        const del = document.createElement("div");
        del.className = "delete-btn";
        del.textContent = "√ó";
del.onclick = () => {
    box.dataset.deleted = "1";   // mark as deleted
    box.remove();                // remove from screen
};
        box.appendChild(del);

        document.getElementById("pdf-container").appendChild(box);
        enableDrag(box);
    });
}


   </script>

{% endblock %}
